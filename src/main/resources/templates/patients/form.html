<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${patient.id != null} ? 'Edit Patient' : 'New Patient'"></title>
    <script>
        function validatePatientId() {
            const patientId = document.getElementById('patientId').value;
            const currentId = document.getElementById('id') ? document.getElementById('id').value : '';

            if (patientId.length >= 3) {
                fetch(`/patients/check-patient-id?patientId=${patientId}&currentId=${currentId}`)
                    .then(response => response.text())
                    .then(data => {
                        const errorSpan = document.getElementById('patientIdError');
                        if (data === 'taken') {
                            errorSpan.textContent = 'This Patient ID is already taken';
                            errorSpan.style.color = 'red';
                        } else {
                            errorSpan.textContent = 'Available';
                            errorSpan.style.color = 'green';
                        }
                    });
            }
        }

        function validateEmail() {
            const email = document.getElementById('email').value;
            const currentId = document.getElementById('id') ? document.getElementById('id').value : '';

            if (email.includes('@')) {
                fetch(`/patients/check-email?email=${email}&currentId=${currentId}`)
                    .then(response => response.text())
                    .then(data => {
                        const errorSpan = document.getElementById('emailError');
                        if (data === 'taken') {
                            errorSpan.textContent = 'This email is already registered';
                            errorSpan.style.color = 'red';
                        } else {
                            errorSpan.textContent = 'Available';
                            errorSpan.style.color = 'green';
                        }
                    });
            }
        }
    </script>
    <style>
        .error { color: red; font-size: 0.9em; }
        .success { color: green; font-size: 0.9em; }
        .form-group { margin-bottom: 15px; }
        label { display: inline-block; width: 150px; font-weight: bold; }
        input, select { padding: 5px; width: 300px; }
        .btn {
            padding: 8px 15px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            border: none;
            border-radius: 3px;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .form-container { max-width: 600px; margin: 0 auto; }
    </style>
</head>
<body>
<div class="form-container">
    <h1 th:text="${patient.id != null} ? 'Edit Patient' : 'Create New Patient'"></h1>

    <form th:action="${patient.id != null} ?
              @{/patients/update/{id}(id=${patient.id})} : @{/patients}"
          th:object="${patient}" method="post">

        <input type="hidden" th:field="*{id}" id="id" />

        <!-- Patient ID -->
        <div class="form-group">
            <label for="patientId">Patient ID:</label>
            <input type="text" id="patientId" th:field="*{patientId}"
                   onblur="validatePatientId()" />
            <br>
            <span th:if="${#fields.hasErrors('patientId')}"
                  th:errors="*{patientId}" class="error"></span>
            <span id="patientIdError"></span>
        </div>

        <!-- Name -->
        <div class="form-group">
            <label for="name">Full Name:</label>
            <input type="text" id="name" th:field="*{name}" />
            <br>
            <span th:if="${#fields.hasErrors('name')}"
                  th:errors="*{name}" class="error"></span>
        </div>

        <!-- Email -->
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" th:field="*{email}"
                   onblur="validateEmail()" />
            <br>
            <span th:if="${#fields.hasErrors('email')}"
                  th:errors="*{email}" class="error"></span>
            <span id="emailError"></span>
        </div>

        <!-- Phone Number -->
        <div class="form-group">
            <label for="phoneNumber">Phone Number:</label>
            <input type="tel" id="phoneNumber" th:field="*{phoneNumber}"
                   placeholder="+1-555-0101" />
            <br>
            <span th:if="${#fields.hasErrors('phoneNumber')}"
                  th:errors="*{phoneNumber}" class="error"></span>
        </div>

        <!-- Date of Birth -->
        <div class="form-group">
            <label for="dateOfBirth">Date of Birth:</label>
            <input type="date" id="dateOfBirth" th:field="*{dateOfBirth}"
                   th:max="${today}" />
            <br>
            <span th:if="${#fields.hasErrors('dateOfBirth')}"
                  th:errors="*{dateOfBirth}" class="error"></span>
        </div>

        <!-- Emergency Contact -->
        <div class="form-group">
            <label for="emergencyContact">Emergency Contact:</label>
            <input type="text" id="emergencyContact" th:field="*{emergencyContact}"
                   placeholder="Name: Phone Number" />
        </div>

        <!-- Buttons -->
        <div class="form-group">
            <button type="submit" class="btn btn-primary">
                <span th:text="${patient.id != null} ? 'Update' : 'Create'"></span> Patient
            </button>
            <a th:href="@{/patients}" class="btn">Cancel</a>
            <a th:href="@{/}" class="btn">Home</a>
        </div>
    </form>
</div>
</body>
</html>