<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Departments</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #f2f2f2; }
        .capacity-ok { color: green; }
        .capacity-full { color: red; }
        .btn { padding: 5px 10px; text-decoration: none; margin: 2px; }
    </style>
</head>
<body>
<h1>Departments
    <span th:if="${hospital}" th:text="' - ' + ${hospital.name}"></span>
</h1>

<!-- Create Button -->
<a th:href="@{/departments/new(hospitalId=${hospital?.id})}" class="btn">Create New Department</a>
<a th:href="@{/departments}" class="btn">All Departments</a>

<!-- Hospital Filter -->
<form method="get" action="/departments">
    <select name="hospitalId" onchange="this.form.submit()">
        <option value="">All Hospitals</option>
        <option th:each="h : ${hospitals}"
                th:value="${h.id}"
                th:text="${h.name}"
                th:selected="${hospital?.id == h.id}">
        </option>
    </select>
</form>

<!-- Search Form -->
<form method="get" action="/departments/search">
    <input type="text" name="name" placeholder="Department name"
           th:value="${searchName}">
    <input type="text" name="departmentHead" placeholder="Department head"
           th:value="${searchHead}">
    <select name="hospitalId">
        <option value="">Any Hospital</option>
        <option th:each="h : ${hospitals}"
                th:value="${h.id}"
                th:text="${h.name}"
                th:selected="${searchHospitalId == h.id}">
        </option>
    </select>
    <select name="hasCapacity">
        <option value="">Any Capacity</option>
        <option value="true" th:selected="${searchHasCapacity == true}">Has Capacity</option>
        <option value="false" th:selected="${searchHasCapacity == false}">Full</option>
    </select>
    <button type="submit">Search</button>
</form>

<!-- Departments Table -->
<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Room Numbers</th>
        <th>Capacity</th>
        <th>Department Head</th>
        <th>Hospital</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="dept : ${departments}">
        <td th:text="${dept.id}"></td>
        <td th:text="${dept.name}"></td>
        <td th:text="${dept.roomNumbers}"></td>
        <td>
                    <span th:if="${dept.hasCapacity()}" class="capacity-ok">
                        Available: <span th:text="${dept.getAvailableCapacity()}"></span>
                    </span>
            <span th:if="${dept.isFull()}" class="capacity-full">
                        FULL
                    </span>
        </td>
        <td th:text="${dept.departmentHead}"></td>
        <td th:text="${dept.hospital.name}"></td>
        <td>
            <a th:href="@{/departments/{id}(id=${dept.id})}" class="btn">View</a>
            <a th:href="@{/departments/edit/{id}(id=${dept.id})}" class="btn">Edit</a>
            <form th:action="@{/departments/{id}/delete(id=${dept.id}, hospitalId=${hospital?.id})}"
                  method="post" style="display: inline;">
                <button type="submit" onclick="return confirm('Delete this department?')">Delete</button>
            </form>

            <!-- Business Actions -->
            <form th:action="@{/departments/{id}/increase-rooms(id=${dept.id}, hospitalId=${hospital?.id})}"
                  method="post" style="display: inline;">
                <input type="number" name="additionalRooms" value="1" min="1" style="width: 50px;">
                <button type="submit">+ Rooms</button>
            </form>

            <form th:action="@{/departments/{id}/decrease-rooms(id=${dept.id}, hospitalId=${hospital?.id})}"
                  method="post" style="display: inline;">
                <input type="number" name="roomsToRemove" value="1" min="1" style="width: 50px;">
                <button type="submit">- Rooms</button>
            </form>
        </td>
    </tr>
    </tbody>
</table>

<div th:if="${departments.empty}">
    <p>No departments found.</p>
</div>
</body>
</html>