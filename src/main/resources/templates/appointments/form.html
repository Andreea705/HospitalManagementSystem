<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${appointment?.id != null} ? 'Edit Appointment' : 'New Appointment'">
        Appointment Form
    </title>
</head>
<body>
<h2 th:text="${appointment?.id != null} ? 'Edit Appointment' : 'New Appointment'">
    Appointment Form
</h2>

<!-- Folosește th:object și th:action corect -->
<form th:object="${appointment}"
      th:action="${appointment?.id != null} ?
                 @{/appointments/update/{id}(id=${appointment.id})} :
                 @{/appointments}"
      method="post">

    <!-- Pentru editare, adaugă câmp ascuns pentru ID -->
    <input type="hidden" th:field="*{id}" th:if="${appointment?.id != null}" />

    <!-- Restul câmpurilor -->
    <div>
        <label for="patientName">Patient Name:</label>
        <input type="text" th:field="*{patientName}" id="patientName" required />
    </div>

    <div>
        <label for="appointmentDate">Appointment Date:</label>
        <input type="datetime-local" th:field="*{appointmentDate}"
               id="appointmentDate"
               th:min="${today}"
               required />
    </div>

    <!-- Departament - doar pentru creare -->
    <div th:if="${appointment?.id == null}">
        <label for="departmentId">Department:</label>
        <select id="departmentId" name="departmentId"
                th:onchange="loadDoctors(this.value)"
                required>
            <option value="">Select Department</option>
            <option th:each="dept : ${departments}"
                    th:value="${dept.id}"
                    th:text="${dept.name}"
                    th:selected="${selectedDepartmentId == dept.id}">
            </option>
        </select>
    </div>

    <!-- Departament pentru editare (doar afișare) -->
    <div th:if="${appointment?.id != null}">
        <label>Department:</label>
        <span th:if="${appointment?.department != null}"
              th:text="${appointment?.department?.name}">Department Name</span>
        <span th:if="${appointment?.department == null}">Not assigned</span>
        <!-- Trimite departmentId ca parametru ascuns -->
        <input type="hidden" name="departmentId"
               th:value="${appointment?.department?.id}"
               th:if="${appointment?.department != null}" />
    </div>

    <!-- Doctor -->
    <div>
        <label for="doctorId">Doctor:</label>
        <select id="doctorId" name="doctorId">
            <option value="">No doctor assigned</option>
            <option th:each="doctor : ${doctors}"
                    th:value="${doctor.id}"
                    th:text="${doctor.medicalStaffName ?: doctor.firstName + ' ' + doctor.lastName}"
                    th:selected="${appointment?.doctor?.id == doctor.id}">
            </option>
        </select>
    </div>

    <!-- Status -->
    <div>
        <label for="status">Status:</label>
        <select th:field="*{status}" id="status" required>
            <option value="">Select Status</option>
            <option th:each="status : ${statuses}"
                    th:value="${status}"
                    th:text="${status}"
                    th:selected="${appointment?.status == status}">
            </option>
        </select>
    </div>

    <!-- Descriere -->
    <div>
        <label for="description">Description:</label>
        <textarea th:field="*{description}" id="description" rows="3"></textarea>
    </div>

    <!-- Butoane -->
    <div style="margin-top: 20px;">
        <button type="submit" th:text="${appointment?.id != null} ? 'Update' : 'Create'">
            Save
        </button>
        <a th:href="@{/appointments}" style="margin-left: 10px;">Cancel</a>
    </div>
</form>

<!-- JavaScript pentru încărcarea doctorilor -->
<script>
    function loadDoctors(departmentId) {
        if (departmentId) {
            window.location.href = '/appointments/new?departmentId=' + departmentId;
        }
    }
</script>
</body>
</html>