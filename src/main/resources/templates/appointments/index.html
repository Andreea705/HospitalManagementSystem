<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Appointments Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .sort-link { text-decoration: none; color: inherit; font-weight: bold; }
        .sort-link:hover { text-decoration: underline; }
        /* Status Badges für professionelle Optik (Anforderung 1.4) */
        .status-badge { padding: 0.4em 0.8em; border-radius: 10px; font-size: 0.85em; font-weight: bold; }
        .status-active { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .status-completed { background-color: #cfe2ff; color: #084298; border: 1px solid #b6d4fe; }
        .status-cancelled { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
    </style>
</head>
<body class="container mt-4">

<div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
    <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
    <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-calendar-event"></i> Appointments Management</h1>
    <div>
        <a th:href="@{/appointments/new}" class="btn btn-success shadow-sm">+ Create New Appointment</a>
        <a th:href="@{/appointments}" class="btn btn-secondary shadow-sm">Reset Filters</a>
    </div>
</div>

<div class="card card-body mb-4 shadow-sm border-primary">
    <form method="get" th:action="@{/appointments}" class="row g-3">
        <div class="col-md-3">
            <label class="form-label fw-bold">Patient Name</label>
            <input type="text" name="name" th:value="${name}" class="form-control" placeholder="Search name...">
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Status</label>
            <select name="status" class="form-select">
                <option value="">All Statuses</option>
                <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}" th:selected="${selectedStatus == s}"></option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label fw-bold">Department</label>
            <select name="deptId" class="form-select">
                <option value="">All Departments</option>
                <option th:each="d : ${departments}" th:value="${d.id}" th:text="${d.name}" th:selected="${selectedDeptId == d.id}"></option>
            </select>
        </div>

        <input type="hidden" name="sortField" th:value="${sortField}">
        <input type="hidden" name="sortDir" th:value="${sortDir}">

        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100 shadow-sm">Apply Filters</button>
        </div>
    </form>
</div>

<div class="table-responsive shadow-sm rounded">
    <table class="table table-hover table-bordered align-middle bg-white">
        <thead class="table-dark text-center">
        <tr>
            <th>ID</th>
            <th>Patient Name</th>
            <th>
                <a class="sort-link text-white" th:href="@{/appointments(name=${name}, status=${selectedStatus}, deptId=${selectedDeptId}, sortField='appointmentDate', sortDir=${reverseSortDir})}">
                    Date <span th:text="${sortField == 'appointmentDate' ? (sortDir == 'asc' ? '↑' : '↓') : ''}"></span>
                </a>
            </th>
            <th>Department</th>
            <th>
                <a class="sort-link text-white" th:href="@{/appointments(name=${name}, status=${selectedStatus}, deptId=${selectedDeptId}, sortField='status', sortDir=${reverseSortDir})}">
                    Status <span th:text="${sortField == 'status' ? (sortDir == 'asc' ? '↑' : '↓') : ''}"></span>
                </a>
            </th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="appointment : ${appointments}">
            <td th:text="${appointment.id}" class="text-center fw-bold"></td>
            <td th:text="${appointment.patientName}"></td>
            <td th:text="${#temporals.format(appointment.appointmentDate, 'dd-MM-yyyy HH:mm')}" class="text-center"></td>
            <td th:text="${appointment.department?.name} ?: 'N/A'"></td>
            <td class="text-center">
                <span th:text="${appointment.status}" th:class="'status-badge status-' + ${#strings.toLowerCase(appointment.status)}"></span>
            </td>
            <td class="text-center">
                <div class="btn-group">
                    <a th:href="@{/appointments/{id}(id=${appointment.id})}" class="btn btn-sm btn-outline-info">View</a>

                    <a th:href="@{/appointments/edit/{id}(id=${appointment.id})}" class="btn btn-sm btn-outline-primary">Edit</a>

                    <form th:action="@{/appointments/{id}/delete(id=${appointment.id})}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this appointment?')">Delete</button>
                    </form>
                </div>
            </td>
        </tr>
        <tr th:if="${#lists.isEmpty(appointments)}">
            <td colspan="6" class="text-center py-4 text-muted">No appointments found matching your criteria.</td>
        </tr>
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>